{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
HEADER SIDEBAR COMPONENT (ready-to-paste)
- phone fallback: settings.phone -> shop.phone -> screenshot number
- formats US numbers for display; builds proper tel: href
- special override: if stored digits == 6822523418 -> force +1 (614) 581-2788
----------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}

{%- assign header_phone = settings.phone | default: shop.phone | default: "+1 (614) 581-2788" -%}
{%- assign digits = header_phone | remove: ' ' | remove: '(' | remove: ')' | remove: '-' | remove: '+' -%}
{%- assign dlen = digits | size -%}
{%- assign first_digit = digits | slice: 0, 1 -%}

{%- comment -%}
  Default formatting logic (safe for theme-check)
{%- endcomment -%}
{%- capture display_phone -%}
  {%- if dlen == 10 -%}
    ({{ digits | slice: 0, 3 }}) {{ digits | slice: 3, 3 }}-{{ digits | slice: 6, 4 }}
  {%- elsif dlen == 11 -%}
    {%- if first_digit == '1' -%}
      +1 ({{ digits | slice: 1, 3 }}) {{ digits | slice: 4, 3 }}-{{ digits | slice: 7, 4 }}
    {%- else -%}
      {{ header_phone }}
    {%- endif -%}
  {%- else -%}
    {{ header_phone }}
  {%- endif -%}
{%- endcapture -%}

{%- comment -%} build tel_href safely {% endcomment -%}
{%- if dlen == 10 -%}
  {%- assign tel_href = '+1' | append: digits -%}
{%- elsif dlen == 11 -%}
  {%- if first_digit == '1' -%}
    {%- assign tel_href = '+' | append: digits -%}
  {%- else -%}
    {%- assign tel_href = digits -%}
  {%- endif -%}
{%- else -%}
  {%- assign tel_href = digits -%}
{%- endif -%}

{%- comment -%}
  OVERRIDE: If a specific bug number (6822523418) is hardcoded into the admin panel,
then we replace it with the correct site number without editing the admin panel.
{%- endcomment -%}
{%- if digits == '6822523418' -%}
  {%- assign display_phone = "+1 (614) 581-2788" -%}
  {%- assign tel_href = "+16145812788" -%}
{%- endif -%}

<template id="header-sidebar-template">
  <div part="base">
    <div part="overlay"></div>

    <div part="content">
      <header part="header">
        <button type="button" is="dialog-close-button" part="close-button tap-area" aria-label="{{ 'general.accessibility.close' | t | escape }}">
          {%- render 'icon' with 'close', width: 16 -%}
        </button>
      </header>

      <div part="panel-list">
        <slot name="main-panel"></slot>

        {%- if menu.levels > 0 -%}
          <slot name="collapsible-panel"></slot>
        {%- endif -%}
      </div>
    </div>
  </div>
</template>

<header-sidebar id="sidebar-menu" class="header-sidebar drawer drawer--sm color-scheme color-scheme--{{ color_scheme.id }}" template="header-sidebar-template" open-from="left">
  {%- comment -%}Panel 1 is the first level{%- endcomment -%}
  <div class="header-sidebar__main-panel" slot="main-panel">
    <div class="header-sidebar__scroller">
      <ul class="header-sidebar__linklist {% if show_dividers %}divide-y{% endif %} unstyled-list" role="list">
        {%- for link in menu.links -%}
          <li>
            {%- if link.links.size > 0 -%}
              <button type="button" class="header-sidebar__linklist-button {% if section.settings.sidebar_text_font == 'heading' %}h6{% endif %}" aria-controls="header-panel-{{ forloop.index }}" aria-expanded="false">
                {{- link.title -}}
                {%- render 'icon' with 'chevron-right', width: 12, direction_aware: true -%}
              </button>
            {%- else -%}
              <a href="{{ link.url }}" class="header-sidebar__linklist-button {% if section.settings.sidebar_text_font == 'heading' %}h6{% endif %}">
                {{- link.title -}}
              </a>
            {%- endif -%}
          </li>
        {%- endfor -%}
      </ul>
    </div>

    {%- liquid
      if section.settings.show_country_selector and localization.available_countries.size > 1
        assign show_country_selector = true
      endif

      if section.settings.show_locale_selector and localization.available_languages.size > 1
        assign show_locale_selector = true
      endif
    -%}

    {%- comment -%}
      Footer block: we always render the phone for mobile.
      Account / localization remain conditional (as it was).
    {%- endcomment -%}
    <div class="header-sidebar__footer md:hidden" role="contentinfo" aria-hidden="false">
      {%- if shop.customer_accounts_enabled -%}
        <a href="{% if customer %}{{ routes.account_url }}{% else %}{{ routes.account_login_url }}{% endif %}" class="text-with-icon smallcaps header-sidebar__account-link">
          {%- render 'icon' with 'account', width: 20 -%}
          {%- if customer -%}
            {{- 'header.general.account' | t -}}
          {%- else -%}
            {{- 'header.general.login' | t -}}
          {%- endif -%}
        </a>
      {%- endif -%}

      {%- if show_country_selector or show_locale_selector -%}
        <div class="localization-selectors header-sidebar__localization">
          {%- if show_country_selector -%}
            {%- render 'localization-selector', type: 'country', placement: 'top-start', show_country_name: section.settings.show_country_name, show_country_flag: section.settings.show_country_flag, id_prefix: 'header-sidebar' -%}
          {%- endif -%}

          {%- if show_country_selector and show_locale_selector -%}
            <span class="localization-selectors__separator" aria-hidden="true"></span>
          {%- endif -%}

          {%- if show_locale_selector -%}
            {%- render 'localization-selector', type: 'locale', placement: 'top-start', id_prefix: 'header-sidebar' -%}
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- if header_phone -%}
        <div class="header-sidebar__phone-wrap" aria-label="Contact phone">
          <a href="tel:{{ tel_href }}" class="header-sidebar__phone-link" aria-label="Call us">
            <span class="header-sidebar__phone-label">Call Us</span>
            <span class="header-sidebar__phone-number">{{ display_phone | strip }}</span>
          </a>
        </div>
      {%- endif -%}
    </div>
  </div>

  {%- comment -%}Panel 2 holds all the second levels{%- endcomment -%}
  {%- if menu.levels > 0 -%}
    <header-sidebar-collapsible-panel class="header-sidebar__collapsible-panel" slot="collapsible-panel">
      <div class="header-sidebar__scroller">
        {%- for link in menu.links -%}
          {%- if link.links.size > 0 -%}
            <div id="header-panel-{{ forloop.index }}" class="header-sidebar__sub-panel" hidden>
              <button type="button" class="header-sidebar__back-button link-faded {% if show_dividers %}is-divided{% endif %} text-with-icon {% if section.settings.sidebar_text_font == 'heading' %}h6{% endif %} md:hidden" data-action="close-panel">
                {%- render 'icon' with 'chevron-left', width: 12, direction_aware: true -%}
                {{- link.title -}}
              </button>

              <ul class="header-sidebar__linklist {% if show_dividers %}divide-y{% endif %} unstyled-list" role="list">
                {%- for sub_link in link.links -%}
                  <li>
                    {%- if sub_link.links.size > 0 -%}
                      <details is="accordion-disclosure" class="group">
                        <summary class="header-sidebar__linklist-button {% if section.settings.sidebar_text_font == 'heading' %}h6{% endif %}">
                          {{- sub_link.title -}}
                          <span class="animated-plus group-expanded:rotate" aria-hidden="true"></span>
                        </summary>

                        <div class="header-sidebar__nested-linklist">
                          {%- for sub_sub_link in sub_link.links -%}
                            <a href="{{ sub_sub_link.url }}" class="link-faded-reverse">{{ sub_sub_link.title }}</a>
                          {%- endfor -%}
                        </div>
                      </details>
                    {%- else -%}
                      <a href="{{ sub_link.url }}" class="header-sidebar__linklist-button {% if section.settings.sidebar_text_font == 'heading' %}h6{% endif %}">
                        {{- sub_link.title -}}
                      </a>
                    {%- endif -%}
                  </li>
                {%- endfor -%}
              </ul>

              {%- liquid
                assign link_title_downcase = link.title | strip | downcase
                assign mega_menu_block = ''

                for block in section.blocks
                  assign menu_item_downcase = block.settings.menu_item | strip | downcase

                  if menu_item_downcase == link_title_downcase
                    assign mega_menu_block = block
                    break
                  endif

                endfor
              -%}

              {%- capture mega_menu_content -%}
                {%- render 'mega-menu-images', context: 'sidebar', block: mega_menu_block -%}
              {%- endcapture -%}

              {%- if mega_menu_content != blank -%}
                <div class="header-sidebar__promo scroll-area bleed md:unbleed">
                  {{- mega_menu_content -}}
                </div>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </header-sidebar-collapsible-panel>
  {%- endif -%}
</header-sidebar>